<h1><%= @plan.name %>
<small>
  <%= @plan.short_desc %><em>(<%= @plan.status %>)</em>
</small>
</h1>
<%= link_to "Back to group", plans_path %>
<% plan_subscription = PlanSubscription.find_by(user: current_user, plan: @plan) %>
<% if plan_subscription  %>
  <% if plan_subscription.status == 'OK' %>
    <%= button_to 'Dismiss', plan_plan_subscription_path(@plan,plan_subscription), method: :patch, params: { status: :KO },
      data: { confirm: "Are you sure?" }  %>
  <% else %>
    <%= button_to 'Join', plan_plan_subscription_path(@plan,plan_subscription), method: :patch, params: { status: :OK }  %>
  <% end %>
<% else %>
  <%= button_to 'Dismiss', plan_plan_subscriptions_path(@plan), params: { status: :KO }  %>
  <%= button_to 'Join', plan_plan_subscriptions_path(@plan), params: { status: :OK }  %>
<% end %>

<% if current_user && (current_user.id == @plan.user.id)%>
  <%= link_to "Edit plan", edit_plan_path(@plan) %>
  <%= link_to "Delete plan", plan_path(@plan), method: :delete, data: { confirm: "Are you sure?" } %>
  <% if ['ACCEPTED','PLANNING'].include? @plan.status %>
    <%= button_to 'Cancel plan', plan_path(@plan), method: :patch, params: { 'plan[status]': :CANCELED }  %>
  <% end %>
  <% if ['CANCELED','PLANNING'].include? @plan.status %>
    <%= button_to 'Accept plan', plan_path(@plan), method: :patch, params: { 'plan[status]': :ACCEPTED}  %>
  <% end %>
  <% if ['CANCELED','ACCEPTED'].include? @plan.status %>
    <%= button_to 'Planning', plan_path(@plan), method: :patch, params: { 'plan[status]': :PLANNING}  %>
  <% end %>
<% end %>

<p>
  Full details: <%= @plan.long_desc %>
</p>

<h4>Dates</h4>
<ul>
  <% @plan.plan_dates.each do |date| %>
  <li>
    start_date: <%= date.start_date %>
    end_date: <%= date.end_date %>
    All_day?: <%= date.all_day %>
    <% if plan_subscription %>
      <% if date.accepted_by_user?(current_user) %>
        Accepted
        <% plan_subscription_ok_date = date.get_subscription_ok_date(current_user) %>
        <%= button_to 'Refuse', plan_subscription_ok_date_path(plan_subscription_ok_date), method: :delete %>
      <% else %>
        Not accepted yet <%= button_to 'Accept', plan_subscription_ok_dates_path,
                                        params: {plan_subscription_id: plan_subscription.id, plan_date_id: date.id} %>
      <% end %>
    <% end %>
    <% if current_user && (current_user.id == @plan.user.id)%>
      <%= button_to 'Delete', plan_plan_date_path(@plan, date), method: :delete, data: { confirm: "Are you sure?" }  %>
    <% end %>
  </li>
  <% end %>
</ul>
<h5>Add new date</h5>
<%= render 'plans/new_plan_date_form', plan: @plan, plan_date: @plan_date%>

<br>
<h4>Locations</h4>
<ul>
  <% @plan.plan_locations.each do |location| %>
  <li>
    name: <%= location.name %>
    <!-- description: <%= location.description %> -->
    address: <%= location.address %>
    <% if current_user && (current_user.id == @plan.user.id)%>
      <%= button_to 'Delete', plan_plan_location_path(@plan, location), method: :delete, data: { confirm: "Are you sure?" }  %>
    <% end %>
  </li>
  <% end %>
</ul>
<h5>Add new location</h5>
<%= render 'plans/new_plan_location_form', plan: @plan, plan_location: @plan_location%>

<h4>Users</h4>
<h5>Users joining</h5>
<ul>
  <% @users_joining.each do |user| %>
  <li>
    <%= user.email %>
  </li>
  <% end %>
</ul>
<h5>Users not responding</h5>
<ul>
  <% @users_not_responding.each do |user| %>
  <li>
    <%= user.email %>
  </li>
  <% end %>
</ul>
<h5>Users dismissing</h5>
<ul>
  <% @users_dismissing.each do |user| %>
  <li>
    <%= user.email %>
  </li>
  <% end %>
</ul>
